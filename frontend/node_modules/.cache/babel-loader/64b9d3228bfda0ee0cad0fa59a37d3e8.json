{"ast":null,"code":"'use strict';\n\nvar net = require('net');\n/**\n * Constructor\n * @param {Object} httpAdapter Http Adapter\n * @param {Object} options     Options (language, client_id, client_secret)\n */\n\n\nvar AGOLGeocoder = function AGOLGeocoder(httpAdapter, options) {\n  if (!httpAdapter || httpAdapter == 'undefined') {\n    throw new Error('ArcGis Online Geocoder requires a httpAdapter to be defined');\n  }\n\n  if (!options || options == 'undefined') {\n    options = {};\n  }\n\n  if (!options.client_id || options.client_id == 'undefined') {\n    options.client_id = null;\n  }\n\n  if (!options.client_secret || options.client_secret == 'undefined') {\n    options.client_secret = null;\n  }\n\n  if (!options.client_secret || !options.client_id) {\n    throw new Error('You must specify the client_id and the client_secret');\n  }\n\n  this.options = options;\n  this.httpAdapter = httpAdapter;\n  this.cache = {};\n};\n\nAGOLGeocoder.prototype._authEndpoint = 'https://www.arcgis.com/sharing/oauth2/token';\nAGOLGeocoder.prototype._endpoint = 'http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/find';\nAGOLGeocoder.prototype._reverseEndpoint = 'http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode'; //Cached vars\n\nAGOLGeocoder.prototype._cachedToken = {\n  'now': function () {\n    return new Date().getTime();\n  },\n  'put': function (token, experation, cache) {\n    cache.token = token; //Shave 30 secs off experation to ensure that we expire slightly before the actual expiration\n\n    cache.tokenExp = this.now() + (experation - 30);\n  },\n  'get': function (cache) {\n    if (!cache) {\n      return null;\n    }\n\n    if (this.now() <= cache.tokenExp) {\n      return cache.token;\n    } else {\n      return null;\n    }\n  }\n};\n\nAGOLGeocoder.prototype._getToken = function (callback) {\n  var _this = this;\n\n  if (_this._cachedToken.get(_this.cache) !== null) {\n    callback(_this._cachedToken.get());\n    return;\n  }\n\n  var params = {\n    'grant_type': 'client_credentials',\n    'client_id': _this.options.client_id,\n    'client_secret': _this.options.client_secret\n  };\n\n  _this.httpAdapter.get(_this._authEndpoint, params, function (err, result) {\n    if (err) {\n      return callback(err);\n    } else {\n      result = JSON.parse(result);\n      var tokenExpiration = new Date().getTime() + result.expires_in;\n      var token = result.access_token;\n\n      _this._cachedToken.put(token, tokenExpiration, _this.cache);\n\n      callback(false, token);\n    }\n  });\n};\n/**\n * Geocode\n * @param {String}   value    Value to geocode (Address)\n * @param {Function} callback Callback method\n */\n\n\nAGOLGeocoder.prototype.geocode = function (value, callback) {\n  var _this = this;\n\n  if (net.isIP(value)) {\n    throw new Error('The AGOL geocoder does not support IP addresses');\n  }\n\n  if (value instanceof Array) {\n    //As defined in http://resources.arcgis.com/en/help/arcgis-rest-api/#/Batch_geocoding/02r300000003000000/\n    throw new Error('An ArcGIS Online organizational account is required to use the batch geocoding functionality');\n  }\n\n  var execute = function (value, token, callback) {\n    var params = {\n      'token': token,\n      'f': 'json',\n      'text': value,\n      'outFields': 'AddNum,StPreDir,StName,StType,City,Postal,Region,Country'\n    };\n\n    _this.httpAdapter.get(_this._endpoint, params, function (err, result) {\n      result = JSON.parse(result);\n\n      if (err) {\n        return callback(err);\n      } else {\n        //This is to work around ESRI's habit of returning 200 OK for failures such as lack of authentication\n        if (result.error) {\n          callback(result.error);\n          return null;\n        }\n\n        var results = [];\n\n        for (var i = 0; i < result.locations.length; i++) {\n          results.push(_this._formatResult(result.locations[i]));\n        }\n\n        results.raw = result;\n        callback(false, results);\n      }\n    });\n  };\n\n  this._getToken(function (err, token) {\n    if (err) {\n      return callback(err);\n    } else {\n      execute(value, token, callback);\n    }\n  });\n};\n\nAGOLGeocoder.prototype._formatResult = function (result) {\n  if (result.address) {\n    return {\n      'latitude': result.location.y,\n      'longitude': result.location.x,\n      'country': result.address.CountryCode,\n      'city': result.address.City,\n      'state': result.address.Region,\n      'zipcode': result.address.Postal,\n      'countryCode': result.address.CountryCode,\n      'address': result.address.Address,\n      'neighborhood': result.address.Neighborhood,\n      'loc_name': result.address.Loc_name\n    };\n  }\n\n  var country = null;\n  var countryCode = null;\n  var city = null;\n  var state = null;\n  var stateCode = null;\n  var zipcode = null;\n  var streetPreDir = null;\n  var streetType = null;\n  var streetName = null;\n  var streetNumber = null;\n  var attributes = result.feature.attributes;\n\n  for (var property in attributes) {\n    if (attributes.hasOwnProperty(property)) {\n      if (property == 'City') {\n        city = attributes[property];\n      }\n\n      if (property == 'Postal') {\n        zipcode = attributes[property];\n      }\n\n      if (property == 'Region') {\n        state = attributes[property];\n      }\n\n      if (property == 'StPreDir') {\n        streetPreDir = attributes[property];\n      }\n\n      if (property == 'AddNum') {\n        streetNumber = attributes[property];\n      }\n\n      if (property == 'StName') {\n        streetName = attributes[property];\n      }\n\n      if (property == 'StType') {\n        streetType = attributes[property];\n      }\n\n      if (property == 'Country') {\n        countryCode = attributes[property];\n        country = attributes[property];\n      }\n    }\n  }\n\n  return {\n    'latitude': result.feature.geometry.y,\n    'longitude': result.feature.geometry.x,\n    'country': country,\n    'city': city,\n    'state': state,\n    'stateCode': stateCode,\n    'zipcode': zipcode,\n    'streetName': streetPreDir + ' ' + streetName + ' ' + streetType,\n    'streetNumber': streetNumber,\n    'countryCode': countryCode\n  };\n};\n/**\n * Reverse geocoding\n * @param {lat:<number>,lon:<number>}  lat: Latitude, lon: Longitude\n * @param {function} callback Callback method\n */\n\n\nAGOLGeocoder.prototype.reverse = function (query, callback) {\n  var lat = query.lat;\n  var long = query.lon;\n\n  var _this = this;\n\n  var execute = function (lat, long, token, callback) {\n    var params = {\n      'token': token,\n      'f': 'json',\n      'location': long + ',' + lat,\n      'outFields': 'AddrNum,StPreDir,StName,StType,City,Postal,Region,Country'\n    };\n\n    _this.httpAdapter.get(_this._reverseEndpoint, params, function (err, result) {\n      result = JSON.parse(result);\n\n      if (err) {\n        return callback(err);\n      } else {\n        //This is to work around ESRI's habit of returning 200 OK for failures such as lack of authentication\n        if (result.error) {\n          callback(result.error, {\n            raw: result\n          });\n          return null;\n        }\n\n        var results = [];\n        results.push(_this._formatResult(result));\n        results.raw = result;\n        callback(false, results);\n      }\n    });\n  };\n\n  this._getToken(function (err, token) {\n    if (err) {\n      return callback(err);\n    } else {\n      execute(lat, long, token, callback);\n    }\n  });\n};\n\nmodule.exports = AGOLGeocoder;","map":null,"metadata":{},"sourceType":"script"}