{"ast":null,"code":"var util = require('util'),\n    AbstractGeocoder = require('./abstractgeocoder');\n/**\n * Constructor\n */\n\n\nvar OpendataFranceGeocoder = function OpendataFranceGeocoder(httpAdapter, options) {\n  this.options = ['language', 'email', 'apiKey'];\n  OpendataFranceGeocoder.super_.call(this, httpAdapter, options);\n};\n\nutil.inherits(OpendataFranceGeocoder, AbstractGeocoder);\nOpendataFranceGeocoder.prototype._endpoint = 'https://api-adresse.data.gouv.fr/search';\nOpendataFranceGeocoder.prototype._endpoint_reverse = 'https://api-adresse.data.gouv.fr/reverse';\n/**\n* Geocode\n* @param <string|object>   value    Value to geocode (Address or parameters, as specified at https://opendatafrance/api/)\n* @param <function> callback Callback method\n*/\n\nOpendataFranceGeocoder.prototype._geocode = function (value, callback) {\n  var _this = this;\n\n  var params = this._getCommonParams();\n\n  if (typeof value == 'string') {\n    params.q = value;\n  } else {\n    if (value.address) {\n      params.q = value.address;\n    }\n\n    if (value.lat && value.lon) {\n      params.lat = value.lat;\n      params.lon = value.lon;\n    }\n\n    if (value.zipcode) {\n      params.postcode = value.zipcode;\n    }\n\n    if (value.type) {\n      params.type = value.type;\n    }\n\n    if (value.citycode) {\n      params.citycode = value.citycode;\n    }\n\n    if (value.limit) {\n      params.limit = value.limit;\n    }\n  }\n\n  this.httpAdapter.get(this._endpoint, params, function (err, result) {\n    if (err) {\n      return callback(err);\n    } else {\n      if (result.error) {\n        return callback(new Error(result.error));\n      }\n\n      var results = [];\n\n      if (result.features) {\n        for (var i = 0; i < result.features.length; i++) {\n          results.push(_this._formatResult(result.features[i]));\n        }\n      }\n\n      results.raw = result;\n      callback(false, results);\n    }\n  });\n};\n\nOpendataFranceGeocoder.prototype._formatResult = function (result) {\n  var latitude = result.geometry.coordinates[1];\n\n  if (latitude) {\n    latitude = parseFloat(latitude);\n  }\n\n  var longitude = result.geometry.coordinates[0];\n\n  if (longitude) {\n    longitude = parseFloat(longitude);\n  }\n\n  var properties = result.properties;\n  var formatedResult = {\n    latitude: latitude,\n    longitude: longitude,\n    state: properties.context,\n    city: properties.city,\n    zipcode: properties.postcode,\n    citycode: properties.citycode,\n    countryCode: 'FR',\n    country: 'France',\n    type: properties.type,\n    id: properties.id\n  };\n\n  if (properties.type === 'housenumber') {\n    formatedResult.streetName = properties.street;\n    formatedResult.streetNumber = properties.housenumber;\n  } else if (properties.type === 'street') {\n    formatedResult.streetName = properties.name;\n  } else if (properties.type === 'city') {\n    formatedResult.population = properties.population;\n    formatedResult.adm_weight = properties.adm_weight;\n  } else if (properties.type === 'village') {\n    formatedResult.population = properties.population;\n  } else if (properties.type === 'locality') {\n    formatedResult.streetName = properties.name;\n  }\n\n  return formatedResult;\n};\n/**\n* Reverse geocoding\n* @param {lat:<number>,lon:<number>, ...}  lat: Latitude, lon: Longitude, ... see https://wiki.openstreetmap.org/wiki/Nominatim#Parameters_2\n* @param <function> callback Callback method\n*/\n\n\nOpendataFranceGeocoder.prototype._reverse = function (query, callback) {\n  var _this = this;\n\n  var params = this._getCommonParams();\n\n  for (var k in query) {\n    var v = query[k];\n    params[k] = v;\n  }\n\n  this.httpAdapter.get(this._endpoint_reverse, params, function (err, result) {\n    if (err) {\n      return callback(err);\n    } else {\n      if (result.error) {\n        return callback(new Error(result.error));\n      }\n\n      var results = [];\n\n      if (result.features) {\n        for (var i = 0; i < result.features.length; i++) {\n          results.push(_this._formatResult(result.features[i]));\n        }\n      }\n\n      results.raw = result;\n      callback(false, results);\n    }\n  });\n};\n/**\n* Prepare common params\n*\n* @return <Object> common params\n*/\n\n\nOpendataFranceGeocoder.prototype._getCommonParams = function () {\n  var params = {};\n\n  for (var k in this.options) {\n    var v = this.options[k];\n\n    if (!v) {\n      continue;\n    }\n\n    if (k === 'language') {\n      k = 'accept-language';\n    }\n\n    params[k] = v;\n  }\n\n  return params;\n};\n\nmodule.exports = OpendataFranceGeocoder;","map":null,"metadata":{},"sourceType":"script"}