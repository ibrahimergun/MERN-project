{"ast":null,"code":"var querystring = require('querystring'),\n    util = require('util'),\n    AbstractGeocoder = require('./abstractgeocoder');\n/**\n * Constructor\n */\n\n\nvar MapQuestGeocoder = function OpenMapQuestGeocoder(httpAdapter, apiKey) {\n  MapQuestGeocoder.super_.call(this, httpAdapter);\n\n  if (!apiKey || apiKey == 'undefined') {\n    throw new Error(this.constructor.name + ' needs an apiKey');\n  }\n\n  this.apiKey = apiKey;\n  this._endpoint = 'https://open.mapquestapi.com/geocoding/v1';\n};\n\nutil.inherits(MapQuestGeocoder, AbstractGeocoder);\n/**\n * Geocode\n * @param <string>   value    Value to geocode (Address)\n * @param <function> callback Callback method\n */\n\nMapQuestGeocoder.prototype._geocode = function (value, callback) {\n  var _this = this;\n\n  this.httpAdapter.get(this._endpoint + '/address', {\n    'location': value,\n    'key': querystring.unescape(this.apiKey)\n  }, function (err, result) {\n    if (err) {\n      return callback(err);\n    } else {\n      if (result.info.statuscode !== 0) {\n        return callback(new Error('Status is ' + result.info.statuscode + ' ' + result.info.messages[0]), {\n          raw: result\n        });\n      }\n\n      var results = [];\n      var locations = result.results[0].locations;\n\n      for (var i = 0; i < locations.length; i++) {\n        results.push(_this._formatResult(locations[i]));\n      }\n\n      results.raw = result;\n      callback(false, results);\n    }\n  });\n};\n\nMapQuestGeocoder.prototype._formatResult = function (result) {\n  var MQConfidenceLookup = {\n    POINT: 1,\n    ADDRESS: 0.9,\n    INTERSECTION: 0.8,\n    //less accurate than the MQ description\n    STREET: 0.7,\n    ZIP: 0.5,\n    ZIP_EXTENDED: 0.5,\n    NEIGHBORHOOD: 0.5,\n    CITY: 0.4,\n    COUNTY: 0.3,\n    STATE: 0.2,\n    COUNTRY: 0.1\n  };\n  return {\n    'latitude': result.latLng.lat,\n    'longitude': result.latLng.lng,\n    'country': null,\n    'countryCode': result.adminArea1,\n    'city': result.adminArea5,\n    'state': result.adminArea3,\n    'zipcode': result.postalCode,\n    'streetName': result.street,\n    'streetNumber': null,\n    'extra': {\n      confidence: MQConfidenceLookup[result.geocodeQuality] || 0\n    }\n  };\n};\n/**\n * Reverse geocoding\n * @param {lat:<number>,lon:<number>}  lat: Latitude, lon: Longitude\n * @param <function> callback Callback method\n */\n\n\nMapQuestGeocoder.prototype._reverse = function (query, callback) {\n  var lat = query.lat;\n  var lng = query.lon;\n\n  var _this = this;\n\n  this.httpAdapter.get(this._endpoint + '/reverse', {\n    'location': lat + ',' + lng,\n    'key': querystring.unescape(this.apiKey)\n  }, function (err, result) {\n    if (err) {\n      return callback(err);\n    } else {\n      var results = [];\n      var locations;\n\n      if (result.results === undefined || !result.results.length) {\n        return callback(new Error('Incorrect response'));\n      }\n\n      locations = result.results[0].locations;\n\n      for (var i = 0; i < locations.length; i++) {\n        results.push(_this._formatResult(locations[i]));\n      }\n\n      results.raw = result;\n      callback(false, results);\n    }\n  });\n};\n\nmodule.exports = MapQuestGeocoder;","map":null,"metadata":{},"sourceType":"script"}